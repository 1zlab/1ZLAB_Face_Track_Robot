# 二自由度云台人脸追踪-1Z实验室





## 项目流程



首先是使用一款名字叫做[IP摄像头的APP](https://www.jianshu.com/p/0586d7dad113) 采集手机摄像头的图像，在手机上建立一个**视频流服务器**。在局域网下，PC通过IP还有端口号获取图像。使用OpenCV的[人脸检测](https://github.com/1zlab/1ZLAB_OpenCV_Face_Detection)的API获取人脸在画面中的位置，根据人脸位置距离画面中心的x轴与y轴的**偏移量(offset)** ，通过**P比例控制(PID控制中最简单的一种)**控制二自由度云台上臂与下臂的旋转角度，将角度信息通过**串口通信UART**发送给**ESP32单片机**(不限于ESP32，STM32,Arduino都可以)解析执行对应的操作，从而使得人脸**尽可能处在画面的正中间**。

> TODO 流程图 配图



开源项目见：

https://github.com/1zlab/1ZLAB_OpenCV_Face_Detection



## 核心控制算法-关于P比例控制



让我们切换一下视角，在云台与摄像头作为第一视角观察这个控制问题。

假如我是舵机云台，而且为了简化问题，我们先只关注控制水平方向的舵机，**假设舵机云台现在只能水平移动**。



### 1-舵机向哪个方向移动？

如果发现这个人在画面中偏左的位置，那么为了实现**让人脸尽可能处在画面的正中间** 的控制目标，是不是我(舵机云台)是不是应该在水平方向上向左移动才是？如果这个人脸在画面中偏右的位置， 舵机云台是不是应该向右移动

> TODO 配图，舵机向左转还是向右转。



### 2-舵机旋转多大的角度？

我们现在知道舵机往哪个角度旋转，那旋转的幅度呢？

这个时候我们就需要参照人脸中心在X轴方向的**偏移量 offset**, 在介绍偏移量`offset`之前我们需要先介绍**目标值(Target)** 还有**实际值(Real)**。 

在我们的这个应用里面，人脸中心的X轴坐标的**目标值(Target)**是整个画面宽度的一半， 如果画面分辨率为`800×600` ，那么对于x轴来讲`x_target = 800/2 = 400` .

**实际值(Real)** 指的就是人脸矩形区域中心在画面中坐标的X轴取值。



什么是**偏移量(Offset)**？即偏移量是指的人脸中心偏移画面中心的值。

```
Offset = Real - Target
偏移量 = 实际值 - 目标值
```



举个例子，如果人脸中心的X坐标是200, 画面中心的X坐标是400（画面分辨率为 800×600）, 那么这里的`x_offset` 就是

```
x_offset = 200 - 400 = -200
```

根据`x_offset` 的正负可以得到舵机角度的旋转方向（角度增大还是减小）。

这里我们仅仅知道偏移量还不够，我们最终的控制量是**舵机角度的增量(变化幅度)**， 所以需要在**偏移量**与**舵机角度的增量**之间建立某种联系。

当偏移量分别为 `1`，`10`， `100` 的时候，显然他们的舵机角度增量是不一样，数值越大那么增量也就越大，如果用数学模型来描述它这种关系就是线性关系`y=k*x`。这里我们定义一个**比例系数(Kp)**来描述这段关系：

```
delta_degree = Kp * x_offset
```

新的舵机角度公式为：

```
新的舵机角度 = 旧的舵机角度 + 角度增量
new_degree = old_degree + delta_degree
```



### 3-Kp比例系数的调参问题

那又来了一个新的问题: **如何确定Kp的取值？**



第一步靠**猜 Guess**



第二步靠**试 Try**





>  TODO **Kp太小与太大都会有什么效果？**
>
> 抖动 或者 太慢
>
> TODO 搭配视频效果



### 4-设置舵机死区

解决在目标值附近抖动的问题

如果offset小于一定的数值就不动



### 5- 结合云台上臂

再考虑进舵机云台上面的控制，与人脸中心举例画面中心的Y轴偏移量有关系。

X轴与Y轴这两个其实是两个相对独立的比例控制。





## 硬件部分







### 1-手机

在手机上（Android或IOS）安装一款名字叫做**IP摄像头**的APP， 它可以将你的手机变为WIFI摄像头。 这种方式，即节省成本，同时也因为手机的性能一般要比WIFI摄像头好，对应的帧率也要高一些。

IP摄像头的详细使用教程见文档 

[IP摄像头APP与OpenCV视频流读取-1Z实验室](https://www.jianshu.com/p/0586d7dad113)



![IP摄像头](./image/ipcamera.png)



当然你也可以选择USB摄像头或者是IP摄像头，自由选择。



### 2-USB转TTL模块





- PWM控制舵机
- 串口通信（通信协议  数据解析）
- I2C 舵机控制板 （pca9685 使用方法介绍）





- 舵机云台校准： （90度位置校准，角度与方向）



